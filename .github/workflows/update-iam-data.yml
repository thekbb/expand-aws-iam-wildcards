name: Update IAM Data

on:
  schedule:
    # Run weekly on Mondays at 9am UTC
    - cron: '0 9 * * 1'
  workflow_dispatch: # Allow manual trigger

permissions:
  contents: write
  pull-requests: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0 # Need full history for tags

      - uses: actions/setup-node@v6
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Update iam-expand package
        run: npm update @cloud-copilot/iam-expand @cloud-copilot/iam-data

      - name: Regenerate IAM data
        run: npm run generate-iam-data

      - name: Rebuild action
        run: npm run build

      - name: Check for changes
        id: changes
        run: |
          if git diff --quiet src/iam-actions.ts; then
            echo "No changes detected - IAM data is up to date"
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "Changes detected - will commit and tag new version"
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: No changes detected
        if: steps.changes.outputs.changed == 'false'
        run: echo "IAM action data is already up to date. Nothing to commit."

      - name: Create pull request
        if: steps.changes.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v7
        with:
          branch: update-iam-actions-${{ github.run_id }}
          delete-branch: true
          title: "Update IAM action data"
          commit-message: "Update IAM action data"
          body: |
            Updates IAM action data generated from @cloud-copilot/iam-data.
          assignees: thekbb
          add-paths: |
            src/iam-actions.ts
            dist/
            package-lock.json
